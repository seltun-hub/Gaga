<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BLE AI Community Finder</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<style>
body{
font-family:system-ui;
background:#0f172a;
color:white;
padding:20px;
}
.card{
background:#1e293b;
padding:20px;
border-radius:20px;
}
button{
width:100%;
padding:14px;
margin-top:12px;
border:none;
border-radius:12px;
font-weight:bold;
}
.primary{background:#3b82f6;color:white;}
.secondary{background:#334155;color:white;}
.ai{background:#16a34a;color:white;}
.status-ok{color:#22c55e;font-weight:bold;}
.status-bad{color:#ef4444;font-weight:bold;}
#map{
height:420px;
margin-top:15px;
border-radius:15px;
display:none;
}
</style>
</head>
<body>

<div class="card">
<h2>BLE AI Community Finder</h2>
<p>Device: <b>Redmi Buds 4 Active</b></p>
<p>Status: <span id="status" class="status-bad">OUT OF RANGE</span></p>

<button class="primary" onclick="connectTag()">Connect Tag (Owner)</button>
<button class="secondary" onclick="communityScan()">Community Scan (No Pair)</button>
<button class="ai" onclick="runAI()">ðŸ§  Run AI Analysis</button>

<div id="aiInfo"></div>
<div id="map"></div>
</div>

<script>

/* ================= FIREBASE ================= */

const firebaseConfig = {
apiKey: "AIzaSyDtoD3Fa6daF6kHsZHRsXgrLwiyxSQCZZk",
authDomain: "ble-tag-finder.firebaseapp.com",
projectId: "ble-tag-finder",
storageBucket: "ble-tag-finder.firebasestorage.app",
messagingSenderId: "658694213686",
appId: "1:658694213686:web:ed81547228034482f44897",
measurementId: "G-WTZ3H6CWNW"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ================= MAP ================= */

let map = L.map("map");
let satellite = L.tileLayer(
"https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
{ attribution: "Tiles Â© Esri" }
);

satellite.addTo(map);
map.setView([24.8170,93.9368],17);

let markers=[];
let aiMarker=null;
let aiCircle=null;

/* ================= OWNER BLE ================= */

let device;
let monitorInterval;

async function connectTag(){
try{
device = await navigator.bluetooth.requestDevice({
acceptAllDevices:true
});
await device.gatt.connect();
updateStatus(true);

device.addEventListener('gattserverdisconnected',()=>{
updateStatus(false);
});

clearInterval(monitorInterval);
monitorInterval=setInterval(()=>{
if(!device.gatt.connected){
updateStatus(false);
}
},2000);

}catch(e){
alert("BLE connect failed.");
}
}

function updateStatus(state){
const el=document.getElementById("status");
if(state){
el.innerText="CONNECTED";
el.className="status-ok";
}else{
el.innerText="OUT OF RANGE";
el.className="status-bad";
}
}

/* ================= COMMUNITY SCAN (NO PAIRING) ================= */

async function communityScan(){

if(!navigator.bluetooth.requestLEScan){
alert("LE Scan not supported in this browser.");
return;
}

try{
const scan = await navigator.bluetooth.requestLEScan({
acceptAllAdvertisements:true
});

navigator.geolocation.getCurrentPosition(async pos=>{

await db.collection("detections").add({
lat:pos.coords.latitude,
lng:pos.coords.longitude,
accuracy:pos.coords.accuracy,
time:Date.now()
});

alert("Precise location uploaded!");

scan.stop();

},{
enableHighAccuracy:true
});

}catch(e){
alert("Scan cancelled.");
}
}

/* ================= OWNER REALTIME ALERT ================= */

db.collection("detections")
.orderBy("time","desc")
.limit(1)
.onSnapshot(snapshot=>{
snapshot.forEach(doc=>{
if(navigator.vibrate){
navigator.vibrate([300,200,300]);
}
alert("Community detected your device!");
});
});

/* ================= AI ANALYSIS ================= */

async function runAI(){

document.getElementById("map").style.display="block";
setTimeout(()=>map.invalidateSize(),300);

markers.forEach(m=>map.removeLayer(m));
markers=[];
if(aiMarker) map.removeLayer(aiMarker);
if(aiCircle) map.removeLayer(aiCircle);

const snap = await db.collection("detections")
.orderBy("time","desc")
.limit(5)
.get();

let points=[];
snap.forEach(doc=>points.push(doc.data()));

if(points.length===0){
alert("No detections found.");
return;
}

// Plot raw detections
points.forEach(p=>{
const m=L.circleMarker([p.lat,p.lng],{
radius:6,
color:"blue"
}).addTo(map);
markers.push(m);
});

// AI centroid
let avgLat=0,avgLng=0;
points.forEach(p=>{
avgLat+=p.lat;
avgLng+=p.lng;
});
avgLat/=points.length;
avgLng/=points.length;

// Outlier filtering using accuracy weighting
let filtered=points.filter(p=>{
return p.accuracy<50; // high precision only
});

if(filtered.length===0) filtered=points;

let finalLat=0,finalLng=0;
filtered.forEach(p=>{
finalLat+=p.lat;
finalLng+=p.lng;
});
finalLat/=filtered.length;
finalLng/=filtered.length;

let confidence=Math.round((filtered.length/points.length)*100);

// Draw AI result
aiMarker=L.marker([finalLat,finalLng])
.addTo(map)
.bindPopup("AI Estimated Location")
.openPopup();

aiCircle=L.circle([finalLat,finalLng],{
radius:40,
color:"yellow",
fillOpacity:0.25
}).addTo(map);

map.setView([finalLat,finalLng],18);

document.getElementById("aiInfo").innerHTML=
`
AI Confidence: ${confidence}% <br>
Detections Used: ${points.length} <br>
Outliers Removed: ${points.length-filtered.length}
`;

}

</script>
</body>
</html>
